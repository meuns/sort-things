# Configure build
EXE_SUFFIX=
ifeq ($(BUILD), DEBUG)
	BUILD_DIR_PATH=./.debug
else ifeq ($(BUILD), PROFILE)
	BUILD_DIR_PATH=./.profile
else
	BUILD_DIR_PATH=./.release
endif

BRANCH_NAME:=$(shell git symbolic-ref --short HEAD)
BUILD_DIR_PATH:=$(BUILD_DIR_PATH)_$(BRANCH_NAME)

ifeq ($(COMPILER), GCC)
	BUILD_DIR_PATH:=$(BUILD_DIR_PATH)_gcc
	EXE_SUFFIX:=$(EXE_SUFFIX)_gcc
else ifeq ($(COMPILER), CLANGCL)
	BUILD_DIR_PATH:=$(BUILD_DIR_PATH)_clangcl
	EXE_SUFFIX:=$(EXE_SUFFIX)_clangcl
else
	BUILD_DIR_PATH:=$(BUILD_DIR_PATH)_clang
	EXE_SUFFIX:=$(EXE_SUFFIX)_clang
	ifeq ($(LTO), ENABLE)
		BUILD_DIR_PATH:=$(BUILD_DIR_PATH)_lto
		EXE_SUFFIX:=$(EXE_SUFFIX)_lto
	else ifeq ($(LTO), VALIDATE)
		BUILD_DIR_PATH:=$(BUILD_DIR_PATH)_lto_v
		EXE_SUFFIX:=$(EXE_SUFFIX)_lto_v
	endif
endif

ifeq ($(BUILD), DEBUG)
	EXE_SUFFIX:=$(EXE_SUFFIX)_d
else ifeq ($(BUILD), PROFILE)
	EXE_SUFFIX:=$(EXE_SUFFIX)_p
else
	EXE_SUFFIX:=$(EXE_SUFFIX)_r
endif

ifeq ($(COMPILER), GCC)
	CC=gcc
	CXX=gcc	
	CFLAGS=-std=c11 -D_XOPEN_SOURCE=600 -Wall -Wextra -Wpedantic -Wformat -Wbool-compare -Wcast-qual -Wconversion -Winit-self -Wrestrict -Wunused -Werror
	CXXFLAGS=-std=c++14 -D_XOPEN_SOURCE=600 -Wall -Wextra -Wpedantic -Wformat -Wbool-compare -Wcast-qual -Wconversion -Winit-self -Wrestrict -Wunused -Werror
	LDFLAGS=
else ifeq ($(COMPILER), CLANGCL)
	CC=clang-cl
	CXX=clang-cl
	CFLAGS=
	CXXFLAGS=
	LDFLAGS=
else
	CC=clang
	CXX=clang
	CFLAGS=-std=c11 -D_XOPEN_SOURCE=600 -Weverything -Werror -Wno-gnu-empty-initializer -Wno-zero-length-array -Wno-vla -Wno-missing-prototypes -Wno-comma -save-temps=obj
	CXXFLAGS=-std=c++14 -D_XOPEN_SOURCE=600 -Weverything -Werror -Wno-gnu-empty-initializer -Wno-zero-length-array -Wno-vla -Wno-missing-prototypes -Wno-comma -save-temps=obj
	LDFLAGS=
endif

ifeq ($(COMPILER), CLANGCL)
	ifeq ($(BUILD), DEBUG)
		CFLAGS+=-Zi -MTd -fuse-ld=lld
		CXXFLAGS+=-Zi -MTd -fuse-ld=lld
		LDFLAGS+=-DEBUG:FULL
	else ifeq ($(BUILD), PROFILE)
		CFLAGS+=-Zi -MTd -fuse-ld=lld
		CXXFLAGS+=-Zi -MTd -fuse-ld=lld
		LDFLAGS+=-DEBUG:FULL
	else
		CFLAGS+=-fuse-ld=lld
		CXXFLAGS+=-fuse-ld=lld
		LDFLAGS+=
	endif
else
	ifeq ($(BUILD), DEBUG)
		CFLAGS+=-g -O0
		CXXFLAGS+=-g -O0
	else ifeq ($(BUILD), PROFILE)
		CFLAGS+=-g -D NDEBUG -O2
		CXXFLAGS+=-g -D NDEBUG -O2
	else
		CFLAGS+=-D NDEBUG -O2
		CXXFLAGS+=-D NDEBUG -O2
		ifeq ($(LTO), ENABLE)
			CFLAGS+=-flto
			CXXFLAGS+=-flto
			LDFLAGS+=-flto -fuse-ld=gold -Wl,-plugin-opt=save-temps
		endif
	endif
endif
